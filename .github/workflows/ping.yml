name: üî• Keep Replit Alive

on:
  schedule:
    - cron: '*/7 * * * *'  # Health check every 7 minutes
    - cron: '*/5 * * * *'  # Warmup every 5 minutes  
  workflow_dispatch:       # Manual trigger

jobs:

  health-check:
    name: ü©∫ Health Check
    # Jalan hanya jika trigger = cron */7 atau manual
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '*/7 * * * *'
    runs-on: ubuntu-latest

    steps:
      - name: Check Replit Health
        run: |
          echo "ü©∫ Checking Replit health..."

          response=$(curl -sS --fail-with-body \
            -o /tmp/response_body \
            -w "%{http_code}" \
            -X GET "${{ secrets.REPLIT_URL }}/health" \
            --max-time 10)

          status=$?

          echo "HTTP Status: $response"
          cat /tmp/response_body

          if [ "$status" -ne 0 ]; then
            echo "‚ö†Ô∏è CURL error: $status"
            exit 0
          fi

          if [ "$response" -ge 300 ]; then
            echo "‚ö†Ô∏è Warning: HTTP $response"
          else
            echo "‚úÖ Health check completed at $(date)"
          fi


  warm-up:
    name: üî• Warm Up
    # Jalan hanya jika trigger = cron */5 atau manual
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '*/5 * * * *'
    runs-on: ubuntu-latest

    steps:
      - name: Warm Up Replit
        run: |
          echo "üî• Warming up Replit..."

          response=$(curl -sS --fail-with-body \
            -o /tmp/response_body \
            -w "%{http_code}" \
            -X GET "${{ secrets.REPLIT_URL }}/warmup" \
            --max-time 10)

          status=$?

          echo "HTTP Status: $response"
          cat /tmp/response_body

          if [ "$status" -ne 0 ]; then
            echo "‚ö†Ô∏è CURL error: $status"
            exit 0
          fi

          if [ "$response" -ge 300 ]; then
            echo "‚ö†Ô∏è Warning: HTTP $response"
          else
            echo "‚úÖ Warmup completed at $(date)"
          fi


  status:
    name: üìä Status Report
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Final Status
        run: |
          echo "üìä Cronjob Execution Report"
          echo "============================"
          echo "Workflow   : ${{ github.workflow }}"
          echo "Trigger    : ${{ github.event_name }}"
          echo "Schedule   : ${{ github.event.schedule }}"
          echo "Time       : $(date)"
          echo "Repository : ${{ github.repository }}"
          echo "============================"
